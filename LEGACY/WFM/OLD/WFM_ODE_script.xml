<?xml version="1.0"?>
<Setup StateDatabaseLocation="{BaseDir}{LogPath}1_TaskStateDatabase_SBD_DTM_Cleaning.db">
	<Log TimingLog="{BaseDir}{LogPath}2_Timing_SBD_DTM_Cleaning.csv"/>
	<Log ErrorLog="{BaseDir}{LogPath}3_Error_SBD_DTM_Cleaning.csv"/>
	<Log InfoLogFile="{BaseDir}{LogPath}4_InfoLogFile_SBD_DTM_Cleaning.txt"/>				
	<GroupTask name="Workflow - Import and Clean SBD MBES Data">

		<SqlServer>10.1.10.66</SqlServer>
		<DatabaseName>ODE_600056_Provider_Onshore</DatabaseName>	

		<GroupTask po="1" name="Define Variable Inputs">
			<SetPropertyTask po="1" name="Define Base Directory" input="E:\ODE_600056\04_PROC_DATA\00_OFFICE\09_WFM" output="BaseDir" level="2" />	
			<InputTask po="2" name="Input NAVISCAN Logging Path" Type="Directory" Output="NScanPath" AskForInput="true" Message="Input Path to NaviScan SBD Files"/>	
			<SetPropertyTask po="3" name="Define NAVISCAN Logging Path" input="{NScanPath}" output="NaviScanLoggingPath" level="2" />
			<GetParentFolderNamesTask po="4" name="Extract Project Name" path="{NaviScanLoggingPath}" output="ProjectFolderName" indexes="1" countfromtheleft="true" directoryseperator="\"/>
			<SplitVariablesTask po="5" name="Isolate Project Name" Input="{ProjectFolderName}" Seperator="\" Output0="blank1" Output1="ProjectName" Output2="blank2" />
			<SetPropertyTask po="6" name="Define Project Name" input="{ProjectName}" output="Proj_Name" level="2" />			
			
			<InputTask po="7" name="Input MBES DTM Cell Size" Type="Property" Output="CellSize" AskForInput="true" Message="Input MBES DTM Cell Size... NOTE: Value in Metres!!"/>	
			<SetPropertyTask po="8" name="Define MBES DTM Cell Size" input="{CellSize}" output="DTMCellSize" level="2" />			
			<InputTask po="9" name="Input S-CAN Cleaning Threshold" Type="Property" Output="ScanThreshold" AskForInput="true" Message="Input S-Can SCORE Cleaning Threshold ... NOTE: Value in Centimetres!!"/>
			<SetPropertyTask po="10" name="Define S-CAN Cleaning Threshold" input="{ScanThreshold}" output="SCAN_Threshold" level="2" />				
		</GroupTask>

		<GroupTask po="2" name="Define Fixed Inputs">
			<SetPropertyTask po="1" name="Define WFM Log Path" input="\02_WORKFLOW_LOGS\SBD_Processing\" output="LogPath" level="2" />				

			<IfTask name="Define DTM Product Units" po="2" Input1="{DTMCellSize}" Operation="less_than" Input2="1"> 
				<GroupTask po="1" name="Centimeter Units">
					<CalculateExpressionTask po="1" name="Calculate DTM Resolution - cm" Expression="{DTMCellSize}*100" output="DTMCellSizecm" level="2" />
					<SetPropertyTask po="2" name="Define DTM Resolution - cm" Input="{DTMCellSizecm}" output="DTMResolutioncm" level="2" />			
					<SplitVariablesTask po="3" name="Extract DTM Resolution - Whole cm" Input="{DTMResolutioncm}" Seperator="." Output0="DTMCellSizeWholecm" Output1="PostDecimalPoint" />
					<SetPropertyTask po="4" name="Define DTM Resolution - Whole cm with Units" Input="{DTMCellSizeWholecm}cm" output="DTMResolutionWithUnits" level="4" />
				</GroupTask>
				
				<GroupTask po="2" name="Metre Units">
					<SetPropertyTask po="1" name="Define DTM Resolution - m" Input="{DTMCellSize}" output="DTMResolutionm" level="2" />
					<SetPropertyTask po="2" name="Define DTM Resolution - Whole m with Units" Input="{DTMResolutionm}m" output="DTMResolutionWithUnits" level="4" />
				</GroupTask>
			</IfTask>

		</GroupTask>							

		<FileWatcherTask po="3" name="Detect and Process SBD Files" logKeyword="Detect and Process SBD Files" Output="SBDFile" Location="{NaviScanLoggingPath}" Filter="*.sbd" Timeout="60000" IncludeSubDir="true"> 
		<GroupTask po="1" name="Process_{SBDFile.Filename}_Data">

		<GroupTask po="1" name="{SBDFile.Filename}">
						
			<OverwritePropertyTask po="1" name="{SBDFile.Filename} - Define SBD File Name" logKeyword="{SBDFile.Filename}" input="{SBDFile.NameWithoutExtension}" output="SBDFileName" level="2" />							

			<!--<GetParentFolderNamesTask po="2" name="{SBDFile.Filename} - Extract SBD Platform Subfolder" logKeyword="{SBDFile.Filename}" path="{SBDFile}" output="SBDWPlatSubFolder" indexes="3" countfromtheleft="true" directoryseperator="\"/>
			<SplitVariablesTask po="3" name="{SBDFile.Filename} - Identify SBD Platform Subfolder" Input="{SBDWPlatSubFolder}" Seperator="\" Output0="blank1" Output1="PlatSubFolderName" Output2="blank2" />	
			<RegExpTask po="4" name="{SBDFile.Filename} - Extract SBD Platform Name" logKeyword="{SBDFile.Filename}" Input="{PlatSubFolderName}" Expression="\S+_([a-zA-Z]+[0-9]+_*[a-zA-Z]*[0-9]*)" Group1="PlatName"/>	-->		
			<OverwritePropertyTask po="5" name="{SBDFile.Filename} - Define SBD Platform Name" logKeyword="{SBDFile.Filename}" input="PROV_WROV" output="PlatformName" level="2" />

			<GetParentFolderNamesTask po="6" name="{SBDFile.Filename} - Extract SBD Level 1 Subfolder" logKeyword="{SBDFile.Filename}" path="{SBDFile}" output="SBDLvl1SubFolder" indexes="5" countfromtheleft="true" directoryseperator="\"/>			
			<SplitVariablesTask po="7" name="{SBDFile.Filename} - Identify SBD Level 1 Subfolder" Input="{SBDLvl1SubFolder}" Seperator="\" Output0="blank1" Output1="Level1SubFolderName" Output2="blank2" />	
			<OverwritePropertyTask po="8" name="{SBDFile.Filename} - Define SBD Level 1 Subfolder" logKeyword="{SBDFile.Filename}" input="{Level1SubFolderName}" output="Level1Folder" level="2" />	

			<GetParentFolderNamesTask po="9" name="{SBDFile.Filename} - Extract Remaining SBD Subfolder Path" logKeyword="{SBDFile.Filename}" path="{SBDFile}" output="SBDSubFolderPath" indexes="6 7 8 9 10 11 12 13 14 15" countfromtheleft="true" directoryseperator="\"/>			
			<OverwritePropertyTask po="10" name="{SBDFile.Filename} - Define Remaining SBD Subfolder Path" logKeyword="{SBDFile.Filename}" input="{SBDSubFolderPath}" output="SBDSubFolder" level="2" />	

			<SetTitleTask po="11" name="Set WorkFlow Title" title="Monitoring for SBD Files - NAVISCAN\05_{PlatformName}\{Level1Folder}{SBDSubFolder}" size="25" red="255" green="255" blue="0" />
				
				<SbdImportTask po="12" name="{SBDFile.Filename} - Import into JobPlanner" logKeyword="{SBDFile.Filename}" output="SBDSQLBlockID" OnError="Restart">
					<NaviEditTask version="1.0">
						<Input xml="{SqlServer}"/>
						<Input xml="{DatabaseName}"/>
						<Geodesy useSbdGeodesy="yes">
						</Geodesy>
						<SbdInterpreter version="1.0">
							<Destination matchFolder="yes" importSVP="no" linkSVP="no">
								<Folder>\01_NaviScan_SBD\{Level1Folder}\{SBDSubFolder}\{PlatformName}</Folder>
							</Destination>
							<Source>
								<FileList>
									{SBDFile} 
								</FileList>
							</Source>
							<Filters>
								<MBEQuality setDeletedFlag="no" qualityThreshold="0"/>
							</Filters>
							<Options disableBathy="no" useOnlineSV="no" onlineSVStart="-1.1" onlineSVEnd="15.5" scanReductionImportEvery="1" />
						</SbdInterpreter>
					</NaviEditTask>
				</SbdImportTask>

				<BlockSettingsTask po="13" name="{SBDFile.Filename} - Switch Bathy to ROVINS" logKeyword="{SBDFile.Filename}" OnError="IgnoreAndContinue">
					<NaviEditTask version="1.0">
						<Input xml="{SqlServer}"/>
						<Input xml="{DatabaseName}"/>
						<SetActiveSensors bathy="0">
							<BlockId>
								{SBDSQLBlockID}
							</BlockId>
						</SetActiveSensors>
					</NaviEditTask>
				</BlockSettingsTask>

				<NMCLITask po="14" name="{SBDFile.Filename} - Create Raw MBES DTM" logKeyword="{SBDFile.Filename}" OnEror="IgnoreAndContinue">
					<Command name="CreateDTM">
						<Files> </Files>
						<Model>
							<CellSize>{DTMCellSize}</CellSize>
							<Path>{BaseDir}\04_DTMS\1_Individual\{Level1Folder}\{SBDSubFolder}\{PlatformName}\{SBDFileName}_Raw_DTM_{DTMResolutionWithUnits}.db</Path>
							<CreateMinimumSurface>yes</CreateMinimumSurface>
							<CreateMaximumSurface>yes</CreateMaximumSurface>
							<CreateMedianSurface>no</CreateMedianSurface>
							<CreateStdSurface>yes</CreateStdSurface>
							<CreateRejectedCountSurface>no</CreateRejectedCountSurface>
							<CreateDeletedCountSurface>no</CreateDeletedCountSurface>
							<CreateBackscatterSurface>yes</CreateBackscatterSurface>							
							<CreateQualitySurface>no</CreateQualitySurface>
							<CreateFileCountSurface>no</CreateFileCountSurface>
							<OverwriteExistingFile>yes</OverwriteExistingFile>
							<ReadIntensity>no</ReadIntensity>
							<CellSizeIntensity>{DTMCellSize}</CellSizeIntensity>							
						</Model>
						<Database>
							<Input xml="{SqlServer}"/>
							<Input xml="{DatabaseName}"/>
							<BlockIds>
								{SBDSQLBlockID}
							</BlockIds>
						</Database>
					</Command>
				</NMCLITask>

				<CopyFileTask po="15" name="{SBDFile.Filename} - Create MBES DTM For Cleaning" logKeyword="{SBDFile.Filename}" OnError="IgnoreAndContinue" Source="{BaseDir}\04_DTMS\1_Individual\{Level1Folder}\{SBDSubFolder}\{PlatformName}\{SBDFileName}_Raw_DTM_{DTMResolutionWithUnits}.db" Destination="{BaseDir}\04_DTMS\1_Individual\{Level1Folder}\{SBDSubFolder}\{PlatformName}\{SBDFileName}_Cleaned_DTM_{DTMResolutionWithUnits}.db" Overwrite="true"/>

				<NMCLITask po="16" name="{SBDFile.Filename} - S-Scan Cleaning" logKeyword="{SBDFile.Filename}" OnEror="IgnoreAndContinue">
					<Command name="ScanScore">
						<Input>
							<dbfile>{BaseDir}\04_DTMS\1_Individual\{Level1Folder}\{SBDSubFolder}\{PlatformName}\{SBDFileName}_Cleaned_DTM_{DTMResolutionWithUnits}.db</dbfile>
							<TempFolder>e:\temp\scalgotemp</TempFolder>
							<threshold>{SCAN_Threshold}</threshold>>
							<DeletePatchFile>yes</DeletePatchFile>
						</Input>
					</Command>
				</NMCLITask>
								
				
				<NMCLITask po="17" name="{SBDFile.Filename} - Write Sounding Edits to SQL" logKeyword="{SBDFile.Filename}" OnEror="IgnoreAndContinue"> 
						<Command name="WriteBack">
							<Input path="{BaseDir}\04_DTMS\1_Individual\{Level1Folder}\{SBDSubFolder}\{PlatformName}\{SBDFileName}_Cleaned_DTM_{DTMResolutionWithUnits}.db"/>
						</Command>
				</NMCLITask>

				<ExternalTask po="18" name="{SBDFile.Filename} - 7Zip SBD File" logKeyword="{SBDFile.Filename}" Location="C:\Program Files\7-Zip\7z.exe" Parameter= "a -t7z -mx=7 &quot;{SBDFile.DirectoryName}&quot;\{SBDFile.NameWithoutExtension}.zip &quot;{SBDFile}&quot;"/>	

				<DeleteFileTask po="19" name="{SBDFile.Filename} - Delete Orig SBD File" logKeyword="{SBDFile.Filename}" OnError="IgnoreAndContinue" File="{SBDFile}"/>
				
		</GroupTask>
		</GroupTask>
		</FileWatcherTask>

		
	</GroupTask>		
</Setup>