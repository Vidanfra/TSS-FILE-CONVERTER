<?xml version="1.0"?>
<!--
    ================================================================================
    EIVA WORKFLOW MANAGER - SBD IMPORT AND EXPORT SCRIPT
    ================================================================================
    
    DESCRIPTION:
        This script automates the import of SBD files into NaviEdit and exports
        PTR files and VisualSoft navigation files for multiple sensor positions.
    
    WORKFLOW:
        1. User selects input folder containing SBD files
        2. User selects output folder for exported files
        3. FileWatcher monitors for new SBD files
        4. Each SBD is imported into NaviEdit with specified geodesy
        5. Block settings are applied (heave, quality threshold)
        6. Exports are generated: PTR + 4x VisualSoft Nav (CRP, PORT, CENTER, STBD)
    
    COMPATIBLE WITH: EIVA WorkFlow Manager 4.10.0.4+
    
    LOG FILES:
        Logs are stored in ./LOGS_WFM_600090_import_export/ relative to this script
    
    ================================================================================
    MANUAL CONFIGURATION REQUIRED - UPDATE BEFORE USE
    ================================================================================
-->
<Setup StateDatabaseLocation=".\LOGS_WFM_600090_import_export\1_WFM_import_export.db">
    <Log TimingLog=".\LOGS_WFM_600090_import_export\2_Timing_WFM_import_export.csv"/>
	<Log ErrorLog=".\LOGS_WFM_600090_import_export\3_Error_WFM_import_export.csv"/>
	<Log InfoLogFile=".\LOGS_WFM_600090_import_export\4_InfoLogFile_WFM_import_export.txt"/>	
				
	<GroupTask name="Import SBD and Export PTR and VisualSoft Nav">

        <!-- ==================== DATABASE CONNECTION (MANUAL CONFIG) ==================== 
             SqlServer:    SQL Server instance name (usually "localhost")
             DatabaseName: NaviEdit project database name - CHANGE FOR EACH PROJECT
        -->
        <SqlServer>localhost</SqlServer>
        <DatabaseName>600090_GOEL_WindMultiplikator</DatabaseName>

        <!-- ==================== DATA SELECTION AND SETUP ==================== 
             User will be prompted to select:
             1. Input folder: Where SBD files are located (will be monitored)
             2. Output folder: Where PTR and navigation files will be exported
             
             The input folder name will be used as the destination folder in NaviEdit database
        -->
        <GroupTask po="1" name="Data selection and setup">
            <InputTask po="1" name="Select INPUT folder (SBD files location)" output="InputDirectory" AskForInput="true"/>
            <SetPropertyTask po="2" name="Define input directory" input="{InputDirectory}" output="NaviScanLoggingPath" level="2"/>
            
            <!-- Extract the folder name from input path to use in NaviEdit database -->
            <GetParentFolderNamesTask po="3" name="Extract Input Folder Name" path="{InputDirectory}" output="InputFolderPath" indexes="1" countfromtheleft="false" directoryseperator="\"/>
            <SetPropertyTask po="4" name="Define NaviEdit Destination Folder" input="{InputFolderPath}" output="NaviEditDestFolder" level="2"/>
            
            <InputTask po="5" name="Select OUTPUT folder (for PTR and Nav exports)" output="OutputDirectory" AskForInput="true"/>
            <SetPropertyTask po="6" name="Define output directory" input="{OutputDirectory}" output="OutputDirectory" level="2"/>
        </GroupTask>


        <!-- ==================== DEFINE VARIABLES ==================== -->
        <GroupTask po="2" name="Define Variable Inputs">
            <!-- USER OFFSET IDs (MANUAL CONFIG) - Must match NaviEdit User Offsets configuration
                 These IDs correspond to sensor positions defined in NaviEdit:
                 - Check NaviEdit > Tools > User Offsets to find correct IDs
                 - IDs are project-specific and must be verified for each project
            -->
            <SetPropertyTask po="1" name="CRP ID" input="1" output="crp_id" level="2"/>        <!-- Common Reference Point -->
            <SetPropertyTask po="2" name="PORT ID" input="2" output="port_id" level="2"/>      <!-- Port side coil/sensor -->
            <SetPropertyTask po="3" name="CENTER ID" input="3" output="center_id" level="2"/>  <!-- Center coil/sensor -->
            <SetPropertyTask po="4" name="STBD ID" input="4" output="stbd_id" level="2"/>      <!-- Starboard coil/sensor -->

            <!-- Project Name Extraction -->
			<GetParentFolderNamesTask po="5" name="Extract Project Name" path="{NaviScanLoggingPath}" output="ProjectFolderName" indexes="1" countfromtheleft="true" directoryseperator="\"/>
			<SplitVariablesTask po="6" name="Isolate Project Name" Input="{ProjectFolderName}" Seperator="\" Output0="blank1" Output1="ProjectName" Output2="blank2" />
			<SetPropertyTask po="7" name="Define Project Name" input="{ProjectName}" output="Proj_Name" level="2" />
        </GroupTask>

        <!-- ==================== FILE WATCHER - IMPORT SBD ==================== -->
        <FileWatcherTask po="2" name="Detect and Process SBD Files" logKeyword="Detect and Process SBD Files" output="SBDFile" location="{NaviScanLoggingPath}" Filter="*.sbd" Timeout="60000" IncludeSubDir="true"> 
        <GroupTask po="1" name="Process_{SBDFile.Filename}_Data">

		<GroupTask po="1" name="{SBDFile.Filename}">
						
			<OverwritePropertyTask po="1" name="{SBDFile.Filename} - Define SBD File Name" logKeyword="{SBDFile.Filename}" input="{SBDFile.NameWithoutExtension}" output="SBDFileName" level="2" />							
			<OverwritePropertyTask po="2" name="{SBDFile.Filename} - Define SBD Platform Name" logKeyword="{SBDFile.Filename}" input="PROV_WROV" output="PlatformName" level="2" />

			<GetParentFolderNamesTask po="3" name="{SBDFile.Filename} - Extract SBD Level 1 Subfolder" logKeyword="{SBDFile.Filename}" path="{SBDFile}" output="SBDLvl1SubFolder" indexes="5" countfromtheleft="true" directoryseperator="\"/>			
			<SplitVariablesTask po="4" name="{SBDFile.Filename} - Identify SBD Level 1 Subfolder" Input="{SBDLvl1SubFolder}" Seperator="\" Output0="blank1" Output1="Level1SubFolderName" Output2="blank2" />	
			<OverwritePropertyTask po="5" name="{SBDFile.Filename} - Define SBD Level 1 Subfolder" logKeyword="{SBDFile.Filename}" input="{Level1SubFolderName}" output="Level1Folder" level="2" />	

			<GetParentFolderNamesTask po="6" name="{SBDFile.Filename} - Extract Remaining SBD Subfolder Path" logKeyword="{SBDFile.Filename}" path="{SBDFile}" output="SBDSubFolderPath" indexes="6 7 8 9 10 11 12 13 14 15" countfromtheleft="true" directoryseperator="\"/>			
			<OverwritePropertyTask po="7" name="{SBDFile.Filename} - Define Remaining SBD Subfolder Path" logKeyword="{SBDFile.Filename}" input="{SBDSubFolderPath}" output="SBDSubFolder" level="2" />	

			<SetTitleTask po="8" name="Set WorkFlow Title" title="Processing SBD: {SBDFileName}" size="25" red="255" green="255" blue="0" />
				
            <!-- ==================== IMPORT SBD TO NAVIEDIT ==================== 
                 GEODESY SETTINGS (MANUAL CONFIG) - CRITICAL FOR CORRECT COORDINATES
                 
                 These settings MUST match your project's geodesy configuration.
                 To find correct values: Open NaviEdit > Import SBD manually > Geodesy tab
                 
                 useSbdGeodesy="no"  : Use settings defined below (recommended for consistency)
                 useSbdGeodesy="yes" : Read from SBD file (may not work reliably in WFM 4.10+)
                 
                 CURRENT CONFIGURATION:
                 - Ellipsoid: International 1924 (EPSG:7022)
                 - Projection: UTM zone 31N (EPSG:32631)
                 - Datum Shift: No shift
                 
                 TO CHANGE FOR DIFFERENT PROJECTS:
                 1. Update Ellipsoid: epsg, name, SemiMajorAxis, InverseFlattening
                 2. Update Projection: epsg, name, OrigLongitude, Zone
                 3. Update Shift if datum transformation is required
                 
                 COMMON CONFIGURATIONS:
                 - WGS84 UTM 32N: epsg="7030", SemiMajorAxis="6378137.0", InverseFlattening="298.257223563"
                                  Projection epsg="32632", OrigLongitude="9", Zone="32"
                 - International 1924 UTM 31N: (current settings)
            -->
            <SbdImportTask po="9" name="{SBDFile.Filename} - Import into NaviEdit" logKeyword="{SBDFile.Filename}" output="SBDSQLBlockID" OnError="Restart">
                <NaviEditTask version="1.0">
                    <SqlServer>{SqlServer}</SqlServer>
                    <DatabaseName>{DatabaseName}</DatabaseName>
                    <Geodesy useSbdGeodesy="no">
                        <Source>
                            <Ellipsoid epsg="7022" name="International 1924">
                                <SemiMajorAxis>6378388.0</SemiMajorAxis>
                                <InverseFlattening>297.0</InverseFlattening>
                            </Ellipsoid>
                            <Projection epsg="32631" name="UTM zone 31N">
                                <EivaType>5</EivaType>
                                <FalseEasting>500000</FalseEasting>
                                <FalseNorthing>0</FalseNorthing>
                                <FirstParallel>0</FirstParallel>
                                <SecondParallel></SecondParallel>
                                <Scale>0.9996</Scale>
                                <OrigLatitude>0</OrigLatitude>
                                <OrigLongitude>3</OrigLongitude>
                                <Zone>31</Zone>
                            </Projection>
                        </Source>
                        <Destination>
                            <Ellipsoid epsg="7022" name="International 1924">
                                <SemiMajorAxis>6378388.0</SemiMajorAxis>
                                <InverseFlattening>297.0</InverseFlattening>
                            </Ellipsoid>
                            <Projection epsg="32631" name="UTM zone 31N">
                                <EivaType>5</EivaType>
                                <FalseEasting>500000</FalseEasting>
                                <FalseNorthing>0</FalseNorthing>
                                <FirstParallel>0</FirstParallel>
                                <SecondParallel></SecondParallel>
                                <Scale>0.9996</Scale>
                                <OrigLatitude>0</OrigLatitude>
                                <OrigLongitude>3</OrigLongitude>
                                <Zone>31</Zone>
                            </Projection>
                        </Destination>
                        <Shift type="0" method="0" name="No shift">
                            <Translation X="0" Y="0" Z="0"/>
                            <Rotation X="0" Y="0" Z="0"/>
                            <ScaleFactor ppm="0"/>
                        </Shift>
                    </Geodesy>
                    <SbdInterpreter version="1.0">
                        <!-- DESTINATION FOLDER IN NAVIEDIT DATABASE
                             matchFolder="yes" : Will use existing folder if it exists, avoiding duplicates
                             The folder name is taken from the input directory selected by user
                        -->
                        <Destination matchFolder="yes" importSVP="no" linkSVP="no">
                            <Folder>\{NaviEditDestFolder}</Folder>
                        </Destination>
                        <Source>
                            <FileList>
                                {SBDFile} 
                            </FileList>
                        </Source>
                        <Filters>
                            <MBEQuality setDeletedFlag="no" qualityThreshold="0"/>
                        </Filters>
                        <Options disableBathy="no" useOnlineSV="no" onlineSVStart="-1.1" onlineSVEnd="15.5" scanReductionImportEvery="1" skipScansWithoutMotion="false"/>
                    </SbdInterpreter>
                </NaviEditTask>
            </SbdImportTask>

            <!-- ==================== APPLY BLOCK SETTINGS ==================== 
                 Block settings applied after import to configure data processing:
                 
                 skipScansWithoutMotion="no" : Include all scans (set "yes" to filter stationary data)
                 useHeave="yes"              : Apply heave compensation to depth data
                 induceHeave="no"            : Don't artificially induce heave
                 disableBathy="no"           : Keep bathymetry data enabled
                 
                 QualityThreshold: Filter beams below this quality level (0-255)
                                   12 is a typical value, adjust based on data quality
            -->
            <BlockSettingsTask po="10" name="{SBDFile.Filename} - Apply Block Settings" logKeyword="{SBDFile.Filename}">
                <NaviEditTask version="1.0">
                    <SqlServer>{SqlServer}</SqlServer>
                    <DatabaseName>{DatabaseName}</DatabaseName>
                    <BlockSettings version="1.0">
                        <BlockId>
                            {SBDSQLBlockID}
                        </BlockId>
                        <Options skipScansWithoutMotion="no" disableBathy="no" useHeave="yes" induceHeave="no"/>
                        <QualityThreshold quality="12"/>
                    </BlockSettings>
                </NaviEditTask>
            </BlockSettingsTask>

            <!-- ==================== EXPORT VISUALSOFT NAV - CRP ==================== -->
            <ExportAsciiTask po="11" name="{SBDFile.Filename} - Export Visualsoft Nav CRP" logKeyword="NAVxport" output=" ">
                <NaviEditTask version="1.0">
                    <SqlServer>{SqlServer}</SqlServer>
                    <DatabaseName>{DatabaseName}</DatabaseName>
                    <Export type="xyvsoftvev">
                        <BlockId>
                            {SBDSQLBlockID}
                        </BlockId>

                        <Output>
                            <Location outputMethod="0" prefixKPRange="no" combineFiles="no" sortCombined="no">
                                <Path>{OutputDirectory}</Path>
                                <AppendPath></AppendPath>
                            </Location>

                            <DbFolderUsage createSubdir="no" prefixFileName="no" useAsFilename="no"/>
                            <Options writeHeader="yes" selectionMethod="0" reduceMethod="0" sortKP="no" interval="10.0"/>
                        </Output>
                        <Units depthScale="1.0" posScale="1.0"/>
                        <Settings addRunlineName="no">
                            <Selection object="{crp_id}"/> 
                            <Singlebeam maxInterpolDist="-1" interpolateDepth="yes"/>
                            <Multibeam averagingWindow="1.0"/> 
                            <NoOfDecimals position="3" depth="3" />
                            <Options downsampleFactor="0" downsampleMinDist="0.0" timeFormat="0" />
                        </Settings>
                    </Export>
                </NaviEditTask>
            </ExportAsciiTask>

            <!-- ==================== EXPORT VISUALSOFT NAV - PORT ==================== -->
            <ExportAsciiTask po="12" name="{SBDFile.Filename} - Export Visualsoft Nav PORT Coil" logKeyword="NAVxport" output=" ">
                <NaviEditTask version="1.0">
                    <SqlServer>{SqlServer}</SqlServer>
                    <DatabaseName>{DatabaseName}</DatabaseName>
                    <Export type="xyvsoftvev">
                        <BlockId>
                            {SBDSQLBlockID}
                        </BlockId>

                        <Output>
                            <Location outputMethod="0" prefixKPRange="no" combineFiles="no" sortCombined="no">
                                <Path>{OutputDirectory}</Path>
                                <AppendPath></AppendPath>
                            </Location>

                            <DbFolderUsage createSubdir="no" prefixFileName="no" useAsFilename="no"/>
                            <Options writeHeader="yes" selectionMethod="0" reduceMethod="0" sortKP="no" interval="10.0"/>
                        </Output>
                        <Units depthScale="1.0" posScale="1.0"/>
                        <Settings addRunlineName="no">
                            <Selection object="{port_id}"/> 
                            <Singlebeam maxInterpolDist="-1" interpolateDepth="yes"/>
                            <Multibeam averagingWindow="1.0"/> 
                            <NoOfDecimals position="3" depth="3" />
                            <Options downsampleFactor="0" downsampleMinDist="0.0" timeFormat="0" />
                        </Settings>
                    </Export>
                </NaviEditTask>
            </ExportAsciiTask>

            <!-- ==================== EXPORT VISUALSOFT NAV - CENTER ==================== -->
            <ExportAsciiTask po="13" name="{SBDFile.Filename} - Export Visualsoft Nav CENTER Coil" logKeyword="NAVxport" output=" ">
                <NaviEditTask version="1.0">
                    <SqlServer>{SqlServer}</SqlServer>
                    <DatabaseName>{DatabaseName}</DatabaseName>
                    <Export type="xyvsoftvev">
                        <BlockId>
                            {SBDSQLBlockID}
                        </BlockId>

                        <Output>
                            <Location outputMethod="0" prefixKPRange="no" combineFiles="no" sortCombined="no">
                                <Path>{OutputDirectory}</Path>
                                <AppendPath></AppendPath>
                            </Location>

                            <DbFolderUsage createSubdir="no" prefixFileName="no" useAsFilename="no"/>
                            <Options writeHeader="yes" selectionMethod="0" reduceMethod="0" sortKP="no" interval="10.0"/>
                        </Output>
                        <Units depthScale="1.0" posScale="1.0"/>
                        <Settings addRunlineName="no">
                            <Selection object="{center_id}"/> 
                            <Singlebeam maxInterpolDist="-1" interpolateDepth="yes"/>
                            <Multibeam averagingWindow="1.0"/> 
                            <NoOfDecimals position="3" depth="3" />
                            <Options downsampleFactor="0" downsampleMinDist="0.0" timeFormat="0" />
                        </Settings>
                    </Export>
                </NaviEditTask>
            </ExportAsciiTask>

            <!-- ==================== EXPORT VISUALSOFT NAV - STARBOARD ==================== -->
            <ExportAsciiTask po="14" name="{SBDFile.Filename} - Export Visualsoft Nav STARBOARD Coil" logKeyword="NAVxport" output=" ">
                <NaviEditTask version="1.0">
                    <SqlServer>{SqlServer}</SqlServer>
                    <DatabaseName>{DatabaseName}</DatabaseName>
                    <Export type="xyvsoftvev">
                        <BlockId>
                            {SBDSQLBlockID}
                        </BlockId>

                        <Output>
                            <Location outputMethod="0" prefixKPRange="no" combineFiles="no" sortCombined="no">
                                <Path>{OutputDirectory}</Path>
                                <AppendPath></AppendPath>
                            </Location>

                            <DbFolderUsage createSubdir="no" prefixFileName="no" useAsFilename="no"/>
                            <Options writeHeader="yes" selectionMethod="0" reduceMethod="0" sortKP="no" interval="10.0"/>
                        </Output>
                        <Units depthScale="1.0" posScale="1.0"/>
                        <Settings addRunlineName="no">
                            <Selection object="{stbd_id}"/> 
                            <Singlebeam maxInterpolDist="-1" interpolateDepth="yes"/>
                            <Multibeam averagingWindow="1.0"/> 
                            <NoOfDecimals position="3" depth="3" />
                            <Options downsampleFactor="0" downsampleMinDist="0.0" timeFormat="0" />
                        </Settings>
                    </Export>
                </NaviEditTask>
            </ExportAsciiTask>

            <!-- ==================== EXPORT PTR ==================== -->
            <ExportAsciiTask po="15" name="{SBDFile.Filename} - Export PTR" logKeyword="PTRxport">
                <NaviEditTask version="1.0">
                    <SqlServer>{SqlServer}</SqlServer>
                    <DatabaseName>{DatabaseName}</DatabaseName>
                    <Export type="xyp_ptr">
                        <BlockId>
                            {SBDSQLBlockID}
                        </BlockId>

                        <Output>
                            <Location outputMethod="0" prefixKPRange="no" combineFiles="no" sortCombined="no">
                                <Path>{OutputDirectory}</Path>
                                <AppendPath></AppendPath>
                            </Location>

                            <DbFolderUsage createSubdir="no" prefixFileName="no" useAsFilename="no"/>
                            <Options writeHeader="yes" sortKP="no" reduceMethod="0" selectionMethod="0" interval="1.0"/>
                        </Output>
                        <Units posScale="1.0" depthScale="1.0"/>
                    </Export>
                </NaviEditTask>
            </ExportAsciiTask>

        </GroupTask>
        </GroupTask>
        </FileWatcherTask>
    </GroupTask>
</Setup>


